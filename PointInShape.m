function in=inpolytope(points,boundvertex,faces)
% Tests if points are in the polytope defined by boundvertex and faces
%
% in=inpolytope(points,boundvertex,faces)
%
% Input:
%
% points: q by d matrix of points to test if they are in the polytope where q is the number of points and d is the number of dimensions, each row is a point.
% boundvertex: w by d matrix of vertexes defining the boundary where q is the number of points and d is the number of dimensions, each row is a vertex.
% faces: f by d matrix of vertex indexes defining the faces of the shape
%
% Output:
%
% in: q by 1 vector of true, false values. True if point in polytope.
dim=columns(boundvertex);
count=zeros(rows(points),1);
for j=1:rows(points)
  a=rand(dim,1);
  b=points(j,:).';
  C=nan(dim,rows(faces));
  for i=1:rows(faces);
    S = (boundvertex(faces(i,2:end),:)-boundvertex(faces(i,1),:))'
    N=externalproduct((boundvertex(faces(i,2:end),:)-boundvertex(faces(i,1),:))');
    c=-boundvertex(faces(i,1),:)*N;
    ##L1=a*t+b;
    ##N'*X+c=0
    t=(-c-N'*b)/(N'*a);
    M=[zeros(dim,1) eye(dim);ones(1,dim+1)]/[boundvertex(faces(i,:),:)' N;ones(1,dim+1)];
    C(:,i)=(a*t+b);
    cp=(M*[C(:,i);1])(1:dim-1);
    if all(cp>=0)&&sum(cp)<=1&&t>0&&~any(sum(abs(C(:,1:i-1)-C(:,i)))==0)
      count(j)++;
    end
  end
end
in=mod(count,2)==1;
end

function w=externalproduct(A)
% Calculates the external product of n-1 column vectors of length n. A generalization of the cross product.
% w=externalproduct(A)
%
% Input:
% A: A n by n-1 matrix
%
% Output
% w: A n by 1 vector
n=rows(A);
if n-1~=columns(A)
  error("externalproduct: A n by n-1 matrix is required.");
end
w=zeros(n,1);
for i=1:n
  w(i)=(-1)^(i-1)*det(A((1:n)~=i,:));
end
end

%{
points=2*rand(100,4);
boundvertex=[0 0 0 0;
1 0 0 0
0 1 0 0
0 0 1 0
0 0 0 1
1 1 0 0
1 0 1 0
1 0 0 1
0 1 1 0
0 1 0 1
0 0 1 1
1 1 1 0
1 1 0 1
1 0 1 1
0 1 1 1
1 1 1 1]+1e-12*randn(16,4);
faces=convhulln(boundvertex);
for i=rows(faces):-1:1;
  N=externalproduct((boundvertex(faces(i,2:end),:)-boundvertex(faces(i,1),:))');
  if norm(N)<1e-8
    faces(i,:)=[];
    continue
  end
  if sum(N.*(boundvertex(faces(i,1),:)'-.5))<0
    faces(i,4:-1:1)=faces(i,:);
  end
end
in=inpolytope(points,boundvertex,faces);
all(in==all(points<1,2))
%}

points=(rand(100,3)-.5)*1.5;

boundvertex=[0.0, 0.0, -1.0
0.5892360806465149, -0.4333856403827667, -0.3646446466445923
-0.2753714621067047, -0.8513333201408386, -0.44325923919677734
-0.8585219979286194, 0.009507948532700539, -0.4133126735687256
-0.261974573135376, 0.7741538286209106, -0.4035138189792633
0.47475239634513855, 0.32490435242652893, -0.31186026334762573
0.2178901731967926, -0.6913977861404419, 0.38427695631980896
-0.618008553981781, -0.4394254684448242, 0.3859737515449524
-0.03054867684841156, 0.09442298114299774, 0.09006057679653168
0.13375593721866608, 0.5913612246513367, 0.35074982047080994
0.5625146627426147, -0.06248609349131584, 0.3461848497390747
-0.04567389935255051, -0.039294712245464325, 0.752822756767273
-0.16245555877685547, -0.49999526143074036, -0.8506544232368469
0.30248892307281494, -0.2541065812110901, -0.6504815220832825
0.266299843788147, -0.810079038143158, -0.5125625729560852
0.7645363807678223, 0.00037657946813851595, -0.4845770299434662
0.33379483222961426, 0.2289578765630722, -0.6521189212799072
-0.4614333212375641, -0.009042318910360336, -0.736072838306427
-0.5255717635154724, -0.36904188990592957, -0.38549506664276123
-0.11817208677530289, 0.39498820900917053, -0.6750578880310059
-0.6659578680992126, 0.46843916177749634, -0.5044936537742615
0.1823621690273285, 0.6130444407463074, -0.3846018314361572
0.7003254890441895, -0.1864262819290161, 0.029026076197624207
0.5578629970550537, 0.15102705359458923, -0.00656328396871686
0.0014843926765024662, -0.839941143989563, -0.003269119653850794
0.48758891224861145, -0.6895740628242493, 0.005454632453620434
0.0740317776799202, -0.19707821309566498, -0.04061112552881241
-0.42095276713371277, -0.6361678838729858, -0.0031451426912099123
-0.05205667018890381, 0.2658112943172455, -0.08162318170070648
0.06106019392609596, -0.05070332810282707, -0.11174663156270981
0.3573247194290161, 0.49188292026519775, -0.01435758825391531
-0.007366125006228685, 0.9767464995384216, 0.019197216257452965
0.44409996271133423, -0.38139721751213074, 0.38702964782714844
-0.263022780418396, -0.8086406588554382, 0.5259535908699036
-0.6856157183647156, 0.011135948821902275, 0.4002482295036316
-0.18068423867225647, 0.5321365594863892, 0.36219456791877747
0.38093313574790955, 0.25800591707229614, 0.3886682689189911
0.16054555773735046, -0.4844474792480469, 0.7983630895614624
0.3301548361778259, -0.06332112848758698, 0.640521764755249
-0.3802613615989685, -0.2911105155944824, 0.7883963584899902
-0.4104889929294586, 0.29053428769111633, 0.8189955353736877
0.06000966578722, 0.33697858452796936, 0.6544434428215027];
faces=[0 13 12
1 13 15
0 12 17
0 17 19
0 19 16
1 15 22
2 14 24
3 18 26
4 20 28
5 21 30
1 22 25
2 24 27
3 26 29
4 28 31
5 30 23
6 32 37
7 33 39
8 34 40
9 35 41
10 36 38
38 41 11
38 36 41
36 9 41
41 40 11
41 35 40
35 8 40
40 39 11
40 34 39
34 7 39
39 37 11
39 33 37
33 6 37
37 38 11
37 32 38
32 10 38
23 36 10
23 30 36
30 9 36
31 35 9
31 28 35
28 8 35
29 34 8
29 26 34
26 7 34
27 33 7
27 24 33
24 6 33
25 32 6
25 22 32
22 10 32
30 31 9
30 21 31
21 4 31
28 29 8
28 20 29
20 3 29
26 27 7
26 18 27
18 2 27
24 25 6
24 14 25
14 1 25
22 23 10
22 15 23
15 5 23
16 21 5
16 19 21
19 4 21
19 20 4
19 17 20
17 3 20
17 18 3
17 12 18
12 2 18
15 16 5
15 13 16
13 0 16
12 14 2
12 13 14
13 1 14]+1;

in=inpolytope(points,boundvertex,faces);

figure(2);clf;
plot3(points(in,1),points(in,2),points(in,3),'g+',points(~in,1),points(~in,2),points(~in,3),'rx');
hold on;axis equal;
ft=[faces faces(:,1) (rows(boundvertex)+1)*ones(rows(faces),1)]'(:);
boundvertex(end+1,:)=nan(1,3);
plot3(boundvertex(ft,1),boundvertex(ft,2),boundvertex(ft,3));

